# Каноническая инструкция и матрица пользовательских потоков

Этот документ является **каноническим baseline** для:
1. пользовательской инструкции;
2. регрессионного тестирования новых фич;
3. проверки, что desktop/mobile поведение синхронизировано.

Пользовательская (человеко-ориентированная) инструкция находится отдельно:
- `docs/guides/user-manual.md`

## Обязательные правила сопровождения

1. Любое изменение пользовательского поведения (UI, навигация, статусы, экспорт/импорт, workflow ролей) требует обновления этого файла в рамках той же задачи.
2. Для каждой UI-задачи в `memory-bank/tasks/.../qa.md` должны быть перечислены затронутые `Flow ID` из этого документа.
3. Для затронутых flow обязательно фиксируются проверки через `playwright-cli` (через `$PWCLI`) и артефакты в `output/playwright/...`.
4. Если flow изменился, но шаги/ожидаемый результат в этом документе не обновлены, задача считается незавершенной.

## Как выбрать нужный режим

1. Определите роль: `student`, `curator`, `admin`.
2. Определите тип экрана:
- `mobile`: ширина `< 768px`;
- `desktop`: ширина `>= 1024px`;
- `768..1023px`: использовать desktop-поток, но с более плотной раскладкой.

---

## Потоки студента

### STU-01 — Вход, регистрация, выбор роли
**Цель:** начать работу новым пользователем.

**Desktop шаги:**
1. Открыть `/`.
2. Выбрать роль (карточки ролей).
3. Ввести имя (минимум 2 символа).
4. Нажать `Продолжить`.

**Mobile шаги:**
1. Выполнить те же шаги на компактной форме.
2. Проверить, что карточки ролей и поле имени доступны без горизонтального скролла.

**Ожидаемый результат:** пользователь создается локально, роль/имя применяются, открывается домашний экран роли.

**Чекпоинты регрессии:**
1. Пустое имя блокирует продолжение с ошибкой.
2. Имя короче 2 символов блокирует продолжение.
3. Выбранная роль сохраняется после перезагрузки.

**UR:** `UR-002`, `UR-003`, `UR-004`, `UR-027`.

### STU-02 — Восстановление профиля (backup/архив)
**Цель:** восстановить рабочее состояние после logout или на другом устройстве.

**Desktop шаги:**
1. На экране входа выбрать пользователя из блока `Ранее сохраненные пользователи`.
2. Либо загрузить `backup JSON` в блоке `Войти из файла профиля`.

**Mobile шаги:**
1. Проверить доступность обоих блоков восстановления.
2. Проверить, что статус восстановления отображается корректно.

**Ожидаемый результат:** восстанавливаются профиль, сессии, student/curator результаты, локальные опросники, язык.

**Чекпоинты регрессии:**
1. Восстановление из архива поднимает данные без загрузки файла.
2. Восстановление из backup файла поднимает те же данные.
3. Ошибочный файл показывает читаемую ошибку.

**UR:** `UR-044`, `UR-068`.

### STU-03 — Настройка профиля
**Цель:** изменить имя, язык, тему и роль.

**Desktop шаги:**
1. Открыть `/profile` (через меню профиля в Header).
2. Изменить имя и сохранить.
3. Изменить язык интерфейса.
4. Изменить тему.
5. При необходимости переключить роль.

**Mobile шаги:**
1. Открыть меню профиля в компактном Header.
2. Перейти в `/profile` и повторить те же действия.

**Ожидаемый результат:** изменения сохраняются в профиле и применяются сразу.

**Чекпоинты регрессии:**
1. Язык меняется без перезагрузки.
2. Тема влияет на все экраны, но не на print/PDF отчет.
3. Переключение роли переводит в соответствующий кабинет.

**UR:** `UR-004`, `UR-020`, `UR-028`, `UR-074`, `UR-077`, `UR-079`.

### STU-04 — Выбор опросника и старт
**Цель:** начать новое прохождение или продолжить paused сессию.

**Desktop шаги:**
1. На домашнем экране создать папку в блоке `Папки опросников` (при необходимости).
2. Переместить опросник в нужную папку или подпапку.
3. В карточке опросника нажать `Начать опрос` (или `Продолжить`, если опрос на паузе).

**Mobile шаги:**
1. Выполнить те же шаги на компактном layout.
2. Проверить, что управление папками и карточки не выходят за экран.

**Ожидаемый результат:** создается/восстанавливается сессия, открывается `QuizTaker` на нужном вопросе.

**Чекпоинты регрессии:**
1. Локальные опросники помечаются бейджем `(локальный)`.
2. Если опрос был на паузе, старт резюмирует сохраненную сессию.
3. При недоступности сервера статических опросников показывается корректный fallback.
4. Структура student-папок сохраняется после перезагрузки страницы.
5. Опросник можно свободно перемещать между root/папками.

**UR:** `UR-005`, `UR-012`, `UR-030`, `UR-045`, `UR-100`, `UR-101`.

### STU-05 — Прохождение вопроса (оценка, подсказки, комментарий)
**Цель:** ответить на вопрос с соблюдением правил схемы.

**Desktop шаги:**
1. Прочитать формулировку и блок `Источники`.
2. Открыть `Показать подсказки для самопроверки`.
3. Выбрать оценку `0..10`.
4. При необходимости добавить комментарий в markdown.
5. Если вопрос с `requires_comment=true`, заполнить комментарий.

**Mobile шаги:**
1. Выполнить те же шаги.
2. Проверить доступность шкалы `0..10` и подсказок без layout overflow.

**Ожидаемый результат:** ответ сохраняется в текущую сессию; переход `Далее/Завершить` доступен только при выполнении обязательных полей.

**Чекпоинты регрессии:**
1. Hover/focus по шкале показывает описание оценки.
2. Для `requires_comment=true` кнопка `Далее/Завершить` заблокирована без текста.
3. Markdown-изображения сохраняются в ответе.

**UR:** `UR-006`, `UR-007`, `UR-008`, `UR-009`, `UR-056`, `UR-065`, `UR-066`, `UR-069`, `UR-090`.

### STU-06 — Пауза и продолжение
**Цель:** безопасно прервать и продолжить прохождение.

**Desktop шаги:**
1. В `QuizTaker` нажать `Пауза`.
2. Вернуться на список опросников.
3. Нажать `Продолжить` в баннере или на карточке нужного опросника.

**Mobile шаги:**
1. Выполнить те же шаги.
2. Проверить компактный баннер `приостановленного опроса`.

**Ожидаемый результат:** сохраняется позиция вопроса и ответы; возможно держать несколько paused-сессий.

**Чекпоинты регрессии:**
1. Пауза не теряет прогресс.
2. Продолжение открывает именно выбранный paused-опросник.
3. После reload paused сессии доступны.

**UR:** `UR-011`, `UR-012`, `UR-041`.

### STU-07 — Завершение опроса и история
**Цель:** завершить попытку и увидеть ее в результатах.

**Desktop шаги:**
1. На последнем вопросе нажать `Завершить`.
2. Перейти в `Мои результаты`.
3. Найти новую попытку в группе соответствующего опросника.

**Mobile шаги:**
1. Повторить те же шаги.
2. Проверить, что карточка попытки и действия корректно переносятся по строкам.

**Ожидаемый результат:** попытка сохранена локально, отражена в групповой истории опросника.

**Чекпоинты регрессии:**
1. Результат содержит дату, баллы, ответы.
2. Заголовки вопросов адаптивно обрезаются в одну строку.
3. Отсутствующие в новой схеме вопросы маркируются.

**UR:** `UR-013`, `UR-014`, `UR-040`, `UR-081`, `UR-082`.

### STU-08 — Экспорт результатов для передачи куратору
**Цель:** выгрузить результаты для проверки.

**Desktop шаги:**
1. Открыть `/dashboard`.
2. Нажать `Экспортировать все` (JSON).
3. Либо экспортировать отдельную попытку из карточки результата.

**Mobile шаги:**
1. Выполнить те же действия.
2. Проверить, что кнопки экспорта доступны в компактном layout.

**Ожидаемый результат:** скачивается JSON-файл результатов для передачи куратору.

**Чекпоинты регрессии:**
1. Экспорт включает комментарии и media payload.
2. Экспорт работает для одной попытки и для всех попыток.

**UR:** `UR-016`, `UR-017`, `UR-032`, `UR-091`, `UR-092`.

### STU-09 — Импорт проверенных результатов и просмотр обратной связи
**Цель:** получить результаты после проверки куратором.

**Desktop шаги:**
1. В `/dashboard` нажать `Импорт результатов`.
2. Выбрать файл, полученный от куратора.
3. Перейти на вкладку `Обратная связь`.

**Mobile шаги:**
1. Повторить те же шаги.
2. Проверить читаемость тредов обратной связи на узкой ширине.

**Ожидаемый результат:** данные импортированы, комментарии куратора видны в `Обратная связь`.

**Чекпоинты регрессии:**
1. Импорт работает с replace-стратегией дедупликации.
2. Если файл некорректен, выводится ошибка.
3. Student scope остается изолирован от curator scope.

**UR:** `UR-024`, `UR-033`, `UR-041`, `UR-049`, `UR-058`.

### STU-10 — Доработка ответов после обратной связи
**Цель:** исправить ответ по замечаниям и подготовить повторную отправку.

**Desktop шаги:**
1. Во вкладке `Обратная связь` открыть нужный вопрос кнопкой `Открыть вопрос`.
2. Система открывает режим редактирования соответствующей попытки.
3. Скорректировать комментарий/оценку.
4. Завершить попытку заново и экспортировать обновленный результат.

**Mobile шаги:**
1. Повторить те же шаги в мобильном layout.

**Ожидаемый результат:** изменения сохранены как обновленный рабочий материал для следующего review-цикла.

**Чекпоинты регрессии:**
1. Фокус возвращается к нужному вопросу.
2. История обратной связи не теряется.
3. Повторный экспорт включает обновленные ответы.

**UR:** `UR-025`, `UR-053`, `UR-055`, `UR-060`.

### STU-11 — Статистика и аналитика
**Цель:** посмотреть динамику и самооценку.

**Desktop шаги:**
1. В `/dashboard` открыть вкладку `Аналитика`.
2. Выбрать опросник.
3. Настроить период (quick range или календарь).
4. Изучить графики распределения и динамики по вопросам.

**Mobile шаги:**
1. Повторить те же шаги.
2. Проверить работу range picker и таблиц без горизонтального overflow.

**Ожидаемый результат:** отображаются только валидные данные по выбранному фильтру и полной шкале `0..10`.

**Чекпоинты регрессии:**
1. Нет категорий low/medium/high.
2. Динамика вопроса показывается только при 2+ оценках.
3. Календарная навигация корректно фильтрует данные.

**UR:** `UR-034`, `UR-042`, `UR-050`, `UR-051`.

### STU-12 — Подготовка документа для печати / PDF
**Цель:** сформировать читаемый отчет по попытке.

**Desktop шаги:**
1. В карточке попытки нажать `Подготовить отчет по оценке`.
2. Проверить inline-preview.
3. Нажать `Скачать` и выбрать формат: `PDF`, `Скачать текст`, `Скачать текст без оформления`, `HTML`.
4. Для печати нажать `Печать`.

**Mobile шаги:**
1. Повторить те же шаги.
2. Проверить работу dropdown и print-кнопки в компактной раскладке.

**Ожидаемый результат:** отчет генерируется по одной попытке, печать и PDF работают стабильно.

**Чекпоинты регрессии:**
1. В отчете нет `questionId` и пустых блоков.
2. Print flow открывается стабильно (без popup-block проблем).
3. PDF/print формируются в читаемой светлой теме независимо от текущей темы приложения.

**UR:** `UR-057`, `UR-060`, `UR-061`, `UR-062`, `UR-063`, `UR-072`, `UR-073`, `UR-075`, `UR-076`, `UR-080`.

### STU-13 — Сохранение профиля для переноса
**Цель:** безопасно завершить работу и перенести профиль.

**Desktop шаги:**
1. Открыть `/profile`.
2. Нажать `Выйти и сохранить файл профиля`.
3. Пройти 2-step подтверждение (confirm + backup warning).
4. Сохранить скачанный backup JSON.

**Mobile шаги:**
1. Выполнить те же шаги через мобильное меню профиля.

**Ожидаемый результат:** скачивается backup файл, данные архивируются локально, пользователь выходит на экран входа.

**Чекпоинты регрессии:**
1. Backup-файл формируется до очистки сессии.
2. После logout пользователь может восстановиться через файл или локальный архив.
3. Для наличия curator-данных поддерживается отдельный curator backup payload в общем профиле.

**UR:** `UR-044`, `UR-058`, `UR-059`, `UR-067`, `UR-068`, `UR-071`, `UR-074`.

---

## Потоки куратора

### CUR-01 — Переключение в режим куратора
**Цель:** перейти в curator workspace.

**Desktop шаги:**
1. Переключить роль в Header или на странице `/profile`.
2. Открыть `/dashboard`.

**Mobile шаги:**
1. Выполнить переключение через компактный Header.
2. Проверить переход в `Панель куратора`.

**Ожидаемый результат:** отображается `CuratorDashboard`, используются только данные curator scope.

**Чекпоинты регрессии:**
1. Student результаты текущего пользователя не смешиваются с curator данными.
2. Метрики куратора отображаются корректно.

**UR:** `UR-004`, `UR-023`, `UR-058`.

### CUR-02 — Загрузка ответов студентов
**Цель:** импортировать файлы студентов для проверки.

**Desktop шаги:**
1. В `CuratorDashboard` нажать `Загрузить ответы студентов`.
2. Выбрать JSON файл.

**Mobile шаги:**
1. Выполнить те же шаги.
2. Проверить статус/ошибку импорта.

**Ожидаемый результат:** ответы импортированы в curator scope, появляются в группах проверки.

**Чекпоинты регрессии:**
1. Импорт summary отображает totals/imported/replaced/skipped/invalid.
2. Некорректный файл не ломает UI и показывает ошибку.

**UR:** `UR-054`, `UR-058`.

### CUR-03 — Проверка ответов и добавление обратной связи
**Цель:** провести review по вопросам и оставить комментарии.

**Desktop шаги:**
1. Открыть активную группу (`студент + опросник`).
2. Нажать `Проверить` у нужной попытки.
3. Для вопроса нажать `+ Добавить обратную связь`.
4. Ввести комментарий/вопрос и нажать `Отправить`.

**Mobile шаги:**
1. Повторить те же шаги.
2. Проверить, что блоки вопросов и feedback editor читаемы на узком экране.

**Ожидаемый результат:** feedback сохраняется в ответе вопроса с authorRole=`curator`.

**Чекпоинты регрессии:**
1. При открытии `pending` результата статус становится `in_review`.
2. Несколько сообщений по одному вопросу сохраняются в тред.
3. Markdown контент feedback рендерится безопасно.

**UR:** `UR-024`, `UR-053`, `UR-055`, `UR-066`.

### CUR-04 — Статусы review и их значения
**Цель:** управлять состоянием проверки.

**Статусы и смысл:**
1. `pending` — результат загружен и еще не открыт куратором.
2. `in_review` — куратор начал проверку (открыт результат или добавлен feedback).
3. `reviewed` — проверка завершена, результат готов к возврату студенту.
4. `needs_revision` — требуется доработка студентом.
5. `approved` — legacy alias; при отображении и в workflow трактуется как `needs_revision`.

**Desktop шаги:**
1. В открытой попытке нажать `Отметить как проверено` или `Отправить на доработку`.

**Mobile шаги:**
1. Выполнить те же действия и проверить корректный badge статуса.

**Ожидаемый результат:** статус и метки группы пересчитываются сразу.

**Чекпоинты регрессии:**
1. Переходы статусов отражаются в счетчиках `pending/reviewed`.
2. Экспорт студенту включает только reviewed/needs_revision результаты.

**UR:** `UR-053`, `UR-055`.

### CUR-05 — Экспорт результатов студенту
**Цель:** передать проверенные материалы обратно студенту.

**Desktop шаги:**
1. Экспорт по группе: `Экспорт проверенных для студента`.
2. Общий экспорт: `Экспортировать все проверенные`.

**Mobile шаги:**
1. Повторить те же действия.

**Ожидаемый результат:** формируется JSON с проверенными попытками для student import.

**Чекпоинты регрессии:**
1. При отсутствии reviewed результатов показывается ошибка.
2. Имя файла формируется с идентификаторами группы/времени.

**UR:** `UR-025`, `UR-055`.

---

## Потоки администратора

### ADM-01 — Переключение в режим админа
**Цель:** открыть единый admin hub.

**Desktop шаги:**
1. Переключить роль на `admin`.
2. Открыть `/dashboard`.
3. Выбрать вкладку: `Обзор`, `Опросники`, `Переводы`, `Миграции и сверка`.

**Mobile шаги:**
1. Повторить те же шаги.
2. Проверить, что tab-навигация доступна и скроллится при необходимости.

**Ожидаемый результат:** admin-функции доступны централизованно в одном профиле.

**Чекпоинты регрессии:**
1. Роуты `/editor` и `/translations` доступны только admin.
2. Для не-admin показывается access denied.

**UR:** `UR-036`, `UR-077`.

### ADM-02 — Редактирование локальных опросников
**Цель:** создавать и поддерживать локальные опросники без redeploy.

**Desktop шаги:**
1. Во вкладке `Опросники` загрузить существующий или импортировать JSON.
2. Изменить metadata, языки, вопросы, `requires_comment`.
3. Нажать `Сохранить в приложение`.
4. При необходимости `Экспортировать файл` или `Удалить кастомный`.

**Mobile шаги:**
1. Выполнить базовые правки.
2. Для больших схем рекомендуется desktop.

**Ожидаемый результат:** опросник валидируется, сохраняется локально и появляется в списке опросников.

**Чекпоинты регрессии:**
1. Добавление языка создает поля перевода для всех вопросов.
2. Валидация блокирует сохранение невалидной схемы.
3. Локальный опросник доступен в student flow и маркируется как локальный.

**UR:** `UR-029`, `UR-030`, `UR-039`, `UR-045`, `UR-056`, `UR-083`, `UR-084`, `UR-086`, `UR-087`.

### ADM-03 — Редактирование и добавление переводов
**Цель:** поддерживать и расширять UI локализацию.

**Desktop шаги:**
1. Во вкладке `Переводы` выбрать язык.
2. Загрузить текущие переводы (`Подгрузить текущие`) или импортировать файл.
3. Отредактировать JSON.
4. Скачать файл перевода.
5. При необходимости экспортировать все переводы.
6. Выполнить аудит покрытия форм и скачать report.

**Mobile шаги:**
1. Разрешены базовые операции.
2. Для массового редактирования JSON использовать desktop.

**Ожидаемый результат:** новые/обновленные переводы экспортируются в файл, покрытие переводов прозрачно контролируется.

**Чекпоинты регрессии:**
1. Ошибочный JSON валидируется и показывает ошибку.
2. Audit-таблица показывает пробелы `ru/en`.
3. Coverage report скачивается.

**UR:** `UR-021`, `UR-037`, `UR-038`, `UR-046`.

### ADM-04 — Операции миграции и сверки
**Цель:** проверить совместимость данных до импорта и принудительно запускать миграции.

**Desktop шаги:**
1. Во вкладке `Миграции и сверка` нажать `Запустить миграции`.
2. Для dry-run сверки загрузить файл результатов в блок `Сверка импорта`.
3. Проанализировать отчет совместимости.

**Mobile шаги:**
1. Допустим запуск базовых операций.
2. Для анализа больших отчетов рекомендуется desktop.

**Ожидаемый результат:** миграции выполняются, сверка дает отчет по совместимости до фактического импорта.

**Чекпоинты регрессии:**
1. Reconciliation корректно считает missingQuestionnaires/missingQuestions.
2. Ошибки не повреждают локальные данные.

**UR:** `UR-019`, `UR-041`, `UR-047`, `UR-048`, `UR-049`.

---

## Обязательная связка с Playwright

Для каждого изменения UI нужно:
1. Определить затронутые `Flow ID` из этого документа.
2. Обновить/добавить соответствующие сценарии `playwright-cli`.
3. Приложить артефакты (`screenshots`, `assert.json`) в задаче.
4. Зафиксировать pass/fail по каждому затронутому flow в `qa.md`.

Команда обновления screenshot baseline:

```bash
npm run docs:user-manual:screenshots
```
